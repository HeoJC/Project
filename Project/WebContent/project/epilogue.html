<!doctype html>
<!-- Website Template by freewebsitetemplates.com -->
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>epilogue</title>
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/mobile.css" media="screen and (max-width : 568px)">
	<script type="text/javascript" src="js/mobile.js"></script>
	<script src="js/top_bar.js"></script>
	<script src="./jquery-3.6.0.min.js"></script>
</head>

<body>
	<div id="header">
		<div id="userInfo"></div>
		<a href="index.html" class="logo">
			<img src="images/logo.jpg" alt="">
		</a>
		<ul id="navigation">
			<li>
				<a href="gallery.html">gallery</a>
			</li>
			<li class="selected">
				<a href="contact.html">contact</a>
			</li>
		</ul>
	</div>
	<div id="up" style="text-align: center; height:3cm;"></div>
	<div id="body">	</div>
	<div id="down" style='height:20cm;'></div>
		
	<script>
	
		// 범수씨가 만든 쿠키에서 정보들 받아오는거
		let memberID = '';
		let memberName = '';
		let memberEMail = '';
		for (let cookies of cookieString) {
			if (cookies.split("=")[0] == "memberID") {
				memberID = cookies.split("=")[1];
				console.log("로그인 아이디: " + memberID);
			}
			if (cookies.split("=")[0] == "memberName") {
				memberName = cookies.split("=")[1];
				console.log("이름: " + memberName);
			}
			if (cookies.split("=")[0] == "memberEMail") {
				memberEMail = cookies.split("=")[1];
				console.log("이메일: " + memberEMail);
			}
		}
		

		
		$("#up").append($("<h1 />").append($("<span id='epiloguetitle'/>").html("구매후기")),
				$("<button id='epilogueinput' onclick='input()'/>").html("입력")) ;
		
		$("#body").append($("<table id='epiloguetablehead' style='margin: auto;'/>")
					.append($("<tr />")
						.append($("<td />")
							.append($("<h4 id='writename'/>").html("작성자 : " + memberID)) ,
						$("<td />")
							.append($("<input type='text' id='epiloguecontent' style='font-size:20px'/>"))))) ,
		$("#body").append($("<table class='epiloguetable' style='margin: auto; font-size:20px; border: 1px solid black'/>")
			.append($("<tr />")
				.append($("<th id='epilogueno'/>").html("번호") ,
				$("<th id='epiloguename'/>").html("작성자") ,
				$("<th id='epiloguecontent'/>").html("내용") ,
				$("<th id='epiloguebutton'/>").html("수정/삭제")))) ;
		
		$("#down").append($("<table id='epiloguetable' style='margin: auto; font-size:20px;'/>"))

		// 방명록 요청 ajax
		$.ajax({
			url : "../EpilogueServlet?cmd=list" ,
			type : "get" ,
			dataType : "json" ,
			success : function (result) {
				for (let row of result) {
					$("#down").append(createDiv(row)) ;
				}
			} ,
			error : function (reject) {
				console.log(reject) ;
			}
		}) ;
		
		function createDiv(row) {
			$("#epiloguetable")
				.append($("<tr id=" + row.id + " name = " + row.name + ">")
						.append($("<td class='epilogueidtd'/>").html(row.id) ,
						$("<td class='epiloguenametd'/>").html(row.name) ,
						$("<td class='epiloguecontenttd'/>").html(row.content) ,
						$("<td />")
							.append($("<button id='epilogueupdate' onclick='update("+ row.id + ")'/>").html("수정"),
									$("<button id='epiloguedelete' onclick='del(" + row.id + ")'/>").html("삭제)")))) ;
		}	
		
		// 등록버튼
		function input() {
		let content = $("#epiloguecontent").val() ;
		console.log(content) ;
			if(memberID == null || memberID == "") {
				alert("로그인 후에 입력 가능합니다") ;
				return ;
			}
			if(content == null || content == "") {
				alert("내용을 입력하세요") ;
				return ;
			}
			
		$.ajax({
			url : "../EpilogueServlet?cmd=add" ,
			type : "get" ,
			data : { name : memberID ,
					 content : content				
			} ,
			dataType : "json" ,
			success : function (result) {
				alert("후기 등록 완료")
				console.log(result) ;
				location.reload() ;
			} ,
			error : function (reject) {
				console.log(reject) ;
			}
		}) ;
		}
		
		// 수정버튼
		function update(rowid) {
			let name = memberID ;
			let id = rowid ;
			if ($("#"+rowid).attr("name") != memberID || $("#"+rowid).attr("name") != "admin") {
				alert("본인 글이거나 관리자인 경우에만 수정이 가능합니다.")
				return ;
			}
			var returnValue = confirm("수정하시겠습니까?") ;
			if (returnValue == false) {
				alert("취소하셨습니다") ;	
				return ;
			}	
		}
		
		// 삭제버튼
		function del(rowid) {
			let name = memberID ;
			let id = rowid ;
			if ($("#"+rowid).attr("name") != memberID || $("#"+rowid).attr("name") != "admin") {
				alert("본인 글이거나 관리자인 경우에만 삭제가 가능합니다.")
				return ;
			}
			var returnValue = confirm("삭제하시겠습니까?") ;
			if (returnValue == false) {
				alert("취소하셨습니다") ;	
				return ;
			}
			alert("삭제하셨습니다") ;
			
			$.ajax({
				url : "../EpilogueServlet?cmd=del" ,
				type : "get" ,
				data : {
					id : id
				} ,
				dataType : "json" ,
				success : function (result) {
					console.log(result) ;
					$("#"+rowid).remove() ;
				} ,
				error : function (reject) {
					console.log(reject) ;
				}
			}) ;
		}
			
	</script>
	<div id="footer">
		<div>
			<p>&copy; 2023 by KIM & HEO. All rights reserved.</p>
			<ul>
				<li>
					<a href="https://twitter.com/" id="twitter">twitter</a>
				</li>
				<li>
					<a href="https://www.facebook.com/" id="facebook">facebook</a>
				</li>
				<li>
					<a href="https://www.google.com/" id="google">google</a>
				</li>
			</ul>
		</div>
	</div>


</body>

</html>